# Directory Structure Standards

**Purpose:** Validate proper separation of committed configuration vs generated/temporary files in TYPO3 extensions

## Why Directory Structure Matters

Proper directory organization prevents common issues:

- ‚úÖ **Version Control Hygiene** - Only configuration committed, not generated files
- ‚úÖ **Build Reproducibility** - Clean installs work without artifacts
- ‚úÖ **CI/CD Clarity** - Clear separation of what's tracked vs generated
- ‚úÖ **Onboarding Efficiency** - New contributors understand structure instantly
- ‚úÖ **Maintenance Simplicity** - Updates don't conflict with local artifacts

Without proper structure:
- ‚ùå Bloated repositories with vendor/, cache files committed
- ‚ùå Git conflicts in generated files
- ‚ùå CI failures from missing .gitignore patterns
- ‚ùå Confusion about what files are source vs generated

## TYPO3 Standard Directory Pattern

### Build/ - Committed Configuration

**Purpose:** Project-specific configuration files that define how to build, test, and validate code

**Characteristics:**
- ‚úÖ Committed to git
- ‚úÖ Shared across all developers
- ‚úÖ Version controlled
- ‚úÖ Defines project standards

**Standard Contents:**

```
Build/
‚îú‚îÄ‚îÄ phpstan.neon              # Static analysis config
‚îú‚îÄ‚îÄ phpstan-baseline.neon     # Known issues baseline (optional)
‚îú‚îÄ‚îÄ php-cs-fixer.php          # Code style config
‚îú‚îÄ‚îÄ rector.php                # Refactoring rules (optional, can be in Build/rector/)
‚îú‚îÄ‚îÄ phpunit/
‚îÇ   ‚îú‚îÄ‚îÄ UnitTests.xml         # Unit test configuration
‚îÇ   ‚îú‚îÄ‚îÄ FunctionalTests.xml   # Functional test configuration
‚îÇ   ‚îî‚îÄ‚îÄ bootstrap.php         # Test bootstrap (if needed)
‚îî‚îÄ‚îÄ Scripts/
    ‚îî‚îÄ‚îÄ runTests.sh           # Test orchestration script
```

**Alternative Rector Location:**
```
Build/
‚îî‚îÄ‚îÄ rector/
    ‚îî‚îÄ‚îÄ rector.php            # Rector config in subdirectory
```

**Git Status:** All files tracked (not in .gitignore)

### .Build/ - Generated/Temporary Files

**Purpose:** Composer-generated files, caches, runtime artifacts, test outputs

**Characteristics:**
- ‚ùå NOT committed to git (gitignored)
- ‚úÖ Generated by composer/build tools
- ‚úÖ Recreatable from configuration
- ‚úÖ Developer-specific caches allowed

**Standard Contents:**

```
.Build/
‚îú‚îÄ‚îÄ bin/                      # Composer bin-dir (phpunit, phpstan, etc.)
‚îú‚îÄ‚îÄ public/                   # Web root (TYPO3 web-dir)
‚îÇ   ‚îú‚îÄ‚îÄ index.php
‚îÇ   ‚îú‚îÄ‚îÄ typo3/
‚îÇ   ‚îî‚îÄ‚îÄ typo3conf/
‚îú‚îÄ‚îÄ vendor/                   # Composer dependencies
‚îú‚îÄ‚îÄ .php-cs-fixer.cache       # php-cs-fixer cache file
‚îú‚îÄ‚îÄ .phpunit.result.cache     # PHPUnit cache
‚îî‚îÄ‚îÄ var/                      # Runtime cache/logs (optional)
```

**Git Status:** Entire directory in .gitignore

**Standard .gitignore Entry:**

```gitignore
# Composer generated files
.Build/
```

## Validation Checklist

### 1. Build/ Directory Structure

**Check for committed configuration files:**

```bash
ls -la Build/
```

**Required files for comprehensive quality:**
- `Build/phpstan.neon` - Static analysis configuration
- `Build/php-cs-fixer.php` - Code style configuration
- `Build/phpunit/UnitTests.xml` - Unit test configuration
- `Build/Scripts/runTests.sh` - Test orchestration

**Optional but recommended:**
- `Build/phpunit/FunctionalTests.xml` - Functional test configuration
- `Build/phpstan-baseline.neon` - Known issues baseline
- `Build/rector.php` or `Build/rector/rector.php` - Refactoring rules

**Severity if missing:** üü° **Medium** - Quality tools not standardized

### 2. .Build/ Directory Gitignore

**Check .gitignore for .Build/ exclusion:**

```bash
grep -E '^\\.Build/' .gitignore
```

**Expected pattern:**

```gitignore
.Build/
```

**Alternative patterns (also valid):**

```gitignore
/.Build/
.Build/*
```

**Check for accidental commits:**

```bash
git ls-files .Build/
# Should return empty - no files from .Build/ should be tracked
```

**Severity if misconfigured:** üî¥ **High** - Can lead to repository bloat

### 3. Composer Configuration Alignment

**Validate composer.json paths match directory structure:**

```bash
# Extract composer paths
cat composer.json | jq -r '.config."bin-dir"'      # Should be .Build/bin
cat composer.json | jq -r '.config."vendor-dir"'   # Should be .Build/vendor
cat composer.json | jq -r '.extra.typo3.cms."web-dir"'  # Should be .Build/public
```

**Expected composer.json:**

```json
{
    "config": {
        "vendor-dir": ".Build/vendor",
        "bin-dir": ".Build/bin"
    },
    "extra": {
        "typo3/cms": {
            "web-dir": ".Build/public"
        }
    }
}
```

**Severity if mismatched:** üî¥ **High** - Build will fail or create wrong structure

### 4. Quality Tool Configuration Paths

**Validate tool configs reference correct cache locations:**

```bash
# Check PHPUnit cache location
grep -r "\.phpunit\.result\.cache" Build/phpunit/*.xml
# Should reference .Build/.phpunit.result.cache or no cache directive

# Check php-cs-fixer cache
grep -r "cache-file" composer.json Build/php-cs-fixer.php
# Should reference .Build/.php-cs-fixer.cache if specified

# Check PHPStan cache (usually auto-managed)
grep -r "tmpDir" Build/phpstan.neon
# Should reference .Build/phpstan if specified, or auto temp
```

**Example CORRECT patterns:**

```json
// composer.json
{
    "scripts": {
        "ci:cgl": [
            "php-cs-fixer fix --cache-file .Build/.php-cs-fixer.cache --dry-run --diff"
        ]
    }
}
```

```php
// Build/php-cs-fixer.php
return (new PhpCsFixer\Config())
    ->setCacheFile('.Build/.php-cs-fixer.cache')
    ->setRules([...]);
```

```neon
# Build/phpstan.neon
parameters:
    tmpDir: .Build/phpstan
```

**Severity if wrong:** üü° **Medium** - Works but creates clutter in Build/

### 5. Tea Extension Reference

**Source:** https://github.com/TYPO3BestPractices/tea

**Tea Directory Structure:**

```
tea/
‚îú‚îÄ‚îÄ .gitignore                    # Excludes .Build/
‚îú‚îÄ‚îÄ Build/
‚îÇ   ‚îú‚îÄ‚îÄ phpstan.neon
‚îÇ   ‚îú‚îÄ‚îÄ phpstan-baseline.neon
‚îÇ   ‚îú‚îÄ‚îÄ php-cs-fixer.php
‚îÇ   ‚îú‚îÄ‚îÄ phpunit/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FunctionalTests.xml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UnitTests.xml
‚îÇ   ‚îî‚îÄ‚îÄ Scripts/
‚îÇ       ‚îî‚îÄ‚îÄ runTests.sh
‚îú‚îÄ‚îÄ .Build/                       # Gitignored, generated by composer
‚îÇ   ‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îî‚îÄ‚îÄ vendor/
‚îî‚îÄ‚îÄ composer.json                 # Defines .Build/ paths
```

**Tea .gitignore (relevant excerpt):**

```gitignore
# Composer-generated files
.Build/
composer.lock
```

**Tea composer.json (relevant excerpt):**

```json
{
    "config": {
        "vendor-dir": ".Build/vendor",
        "bin-dir": ".Build/bin"
    },
    "extra": {
        "typo3/cms": {
            "web-dir": ".Build/public"
        }
    }
}
```

## Common Issues and Fixes

### Issue 1: Cache Files in Build/ Directory

**Diagnosis:**

```bash
ls -la Build/.php-cs-fixer.cache Build/.phpunit.result.cache
# If these files exist, they're in the WRONG location
```

**Problem:** Cache files committed or in wrong directory

**Fix:**

```bash
# Remove from wrong location
rm Build/.php-cs-fixer.cache Build/.phpunit.result.cache

# Update configuration to use .Build/
```

**Update php-cs-fixer config:**

```php
// Build/php-cs-fixer.php
return (new PhpCsFixer\Config())
    ->setCacheFile('.Build/.php-cs-fixer.cache')  // ‚úÖ Correct location
    // ...
```

**Update composer scripts:**

```json
{
    "scripts": {
        "ci:cgl": [
            "php-cs-fixer fix --cache-file .Build/.php-cs-fixer.cache --dry-run --diff"
        ]
    }
}
```

### Issue 2: .Build/ Files Committed to Git

**Diagnosis:**

```bash
git ls-files .Build/
# Should be empty
```

**Problem:** Generated files tracked in git (vendor/, bin/, etc.)

**Fix:**

```bash
# Remove from git tracking
git rm -r --cached .Build/

# Ensure .gitignore has entry
echo ".Build/" >> .gitignore

# Commit the cleanup
git add .gitignore
git commit -m "fix: remove .Build/ from git tracking, add to .gitignore"
```

### Issue 3: Missing Build/ Directory

**Diagnosis:**

```bash
ls -la Build/
# Directory doesn't exist
```

**Problem:** No standardized quality tool configuration

**Fix:**

```bash
# Create Build/ directory structure
mkdir -p Build/{phpunit,Scripts}

# Add quality tool configs (see templates below)
# Then commit
git add Build/
git commit -m "feat: add Build/ directory with quality tool configurations"
```

### Issue 4: Rector in Wrong Location

**Diagnosis:**

```bash
# Check for rector.php in project root
ls -la rector.php

# Should be in Build/ or Build/rector/ instead
```

**Problem:** Configuration file in project root instead of Build/

**Fix:**

```bash
# Option 1: Move to Build/
mv rector.php Build/rector.php

# Option 2: Move to Build/rector/ (preferred for complex configs)
mkdir -p Build/rector
mv rector.php Build/rector/rector.php

# Update paths in rector.php
# Then commit
git add Build/
git rm rector.php
git commit -m "refactor: move rector config to Build/ directory"
```

## Conformance Report Integration

### When Evaluating Directory Structure:

**In "Best Practices" Section:**

```markdown
### Directory Structure

**Analysis:**

- ‚úÖ Build/ directory present with committed configurations
- ‚úÖ Build/phpstan.neon, Build/php-cs-fixer.php present
- ‚úÖ Build/phpunit/ directory with test configs
- ‚úÖ Build/Scripts/runTests.sh present
- ‚úÖ .Build/ properly gitignored (entire directory)
- ‚úÖ Composer paths correctly reference .Build/
- ‚úÖ Cache files located in .Build/, not Build/
- ‚úÖ No .Build/ files committed to git

**Or with issues:**

- ‚ùå Cache files in wrong location
  - Files: Build/.php-cs-fixer.cache, Build/.phpunit.result.cache
  - Expected: .Build/.php-cs-fixer.cache, .Build/.phpunit.result.cache
  - Severity: Medium
  - Fix: Move cache files to .Build/ and update configs

- ‚ùå .Build/ files committed to git
  - Files: .Build/vendor/, .Build/bin/
  - Command: `git ls-files .Build/` shows tracked files
  - Severity: High
  - Fix: `git rm -r --cached .Build/` and ensure .gitignore has `.Build/`

- ‚ö†Ô∏è  Missing Build/ directory
  - Impact: No standardized quality tool configuration
  - Severity: Medium
  - Recommendation: Create Build/ with phpstan.neon, php-cs-fixer.php, phpunit configs
```

## Scoring Impact

**Best Practices Score Deductions:**

| Issue | Severity | Score Impact |
|-------|----------|--------------|
| .Build/ files committed | High | -4 points |
| Cache files in Build/ | Medium | -2 points |
| Missing .gitignore for .Build/ | High | -3 points |
| Composer paths don't match structure | High | -3 points |
| Missing Build/ directory | Medium | -2 points |
| Rector/configs in project root | Low | -1 point |

**Maximum deduction for directory issues:** -6 points (out of 20 for Best Practices)

## Automated Validation Script

Create `scripts/validate-directory-structure.sh`:

```bash
#!/bin/bash

set -e

echo "üîç Validating directory structure..."

ISSUES=0

# Check 1: .Build/ should be gitignored
if ! grep -qE '^\\.Build/' .gitignore; then
    echo "‚ùå .gitignore missing '.Build/' entry"
    ISSUES=$((ISSUES + 1))
else
    echo "‚úÖ .Build/ properly gitignored"
fi

# Check 2: No .Build/ files should be tracked
TRACKED_BUILD=$(git ls-files .Build/ 2>/dev/null | wc -l)
if [ "${TRACKED_BUILD}" -gt 0 ]; then
    echo "‚ùå .Build/ files are committed to git:"
    git ls-files .Build/
    ISSUES=$((ISSUES + 1))
else
    echo "‚úÖ No .Build/ files tracked in git"
fi

# Check 3: Build/ directory should exist
if [ ! -d "Build" ]; then
    echo "‚ö†Ô∏è  Build/ directory missing"
    ISSUES=$((ISSUES + 1))
else
    echo "‚úÖ Build/ directory exists"

    # Check for standard files
    [ -f "Build/phpstan.neon" ] && echo "  ‚úÖ phpstan.neon" || echo "  ‚ö†Ô∏è  phpstan.neon missing"
    [ -f "Build/php-cs-fixer.php" ] && echo "  ‚úÖ php-cs-fixer.php" || echo "  ‚ö†Ô∏è  php-cs-fixer.php missing"
    [ -d "Build/phpunit" ] && echo "  ‚úÖ phpunit/" || echo "  ‚ö†Ô∏è  phpunit/ missing"
    [ -f "Build/Scripts/runTests.sh" ] && echo "  ‚úÖ runTests.sh" || echo "  ‚ö†Ô∏è  runTests.sh missing"
fi

# Check 4: Cache files should NOT be in Build/
if [ -f "Build/.php-cs-fixer.cache" ] || [ -f "Build/.phpunit.result.cache" ]; then
    echo "‚ùå Cache files in wrong location (Build/ instead of .Build/):"
    ls -la Build/.*.cache 2>/dev/null || true
    ISSUES=$((ISSUES + 1))
else
    echo "‚úÖ No cache files in Build/"
fi

# Check 5: Composer paths should reference .Build/
BIN_DIR=$(jq -r '.config."bin-dir" // ".Build/bin"' composer.json)
VENDOR_DIR=$(jq -r '.config."vendor-dir" // ".Build/vendor"' composer.json)
WEB_DIR=$(jq -r '.extra.typo3.cms."web-dir" // ".Build/public"' composer.json)

if [ "${BIN_DIR}" = ".Build/bin" ]; then
    echo "‚úÖ Composer bin-dir: ${BIN_DIR}"
else
    echo "‚ö†Ô∏è  Composer bin-dir: ${BIN_DIR} (expected .Build/bin)"
    ISSUES=$((ISSUES + 1))
fi

if [ "${VENDOR_DIR}" = ".Build/vendor" ]; then
    echo "‚úÖ Composer vendor-dir: ${VENDOR_DIR}"
else
    echo "‚ö†Ô∏è  Composer vendor-dir: ${VENDOR_DIR} (expected .Build/vendor)"
    ISSUES=$((ISSUES + 1))
fi

if [ "${WEB_DIR}" = ".Build/public" ]; then
    echo "‚úÖ TYPO3 web-dir: ${WEB_DIR}"
else
    echo "‚ö†Ô∏è  TYPO3 web-dir: ${WEB_DIR} (expected .Build/public)"
    ISSUES=$((ISSUES + 1))
fi

echo ""
if [ ${ISSUES} -eq 0 ]; then
    echo "‚úÖ Directory structure validation complete - no issues found"
    exit 0
else
    echo "‚ùå Directory structure validation found ${ISSUES} issue(s)"
    exit 1
fi
```

## Quick Reference Checklist

**When evaluating directory structure:**

```
‚ñ° .gitignore contains .Build/ entry
‚ñ° Build/ directory exists and contains configs
‚ñ° Build/phpstan.neon exists
‚ñ° Build/php-cs-fixer.php exists
‚ñ° Build/phpunit/ directory exists with XML configs
‚ñ° Build/Scripts/runTests.sh exists
‚ñ° .Build/ is NOT tracked in git (git ls-files .Build/ is empty)
‚ñ° Cache files are in .Build/, not Build/
‚ñ° Composer bin-dir = .Build/bin
‚ñ° Composer vendor-dir = .Build/vendor
‚ñ° TYPO3 web-dir = .Build/public
‚ñ° No configuration files in project root (rector.php, phpstan.neon, etc.)
‚ñ° Root-only configs stay at root (renovate.json, grumphp.yml, infection.json5)
```

## Root vs Build/ Configuration Files

Some tools **require** configuration at project root due to auto-discovery conventions:

| File | Location | Reason |
|------|----------|--------|
| `composer.json` | Root ‚úÖ | Composer requirement |
| `renovate.json` | Root ‚úÖ | Renovate Bot auto-discovery |
| `grumphp.yml` | Root ‚úÖ | GrumPHP convention |
| `infection.json5` | Root ‚úÖ | Infection auto-discovery |
| `.editorconfig` | Root ‚úÖ | IDE convention |
| `phpstan.neon` | Build/ ‚úÖ | Supports `--config` flag |
| `php-cs-fixer.php` | Build/ ‚úÖ | Supports `--config` flag |
| `rector.php` | Build/ ‚úÖ | Supports `--config` flag |
| `fractor.php` | Build/ ‚úÖ | Supports `--config` flag |
| `phpcs.xml` | Build/ ‚úÖ | Supports `--standard` flag |

**Rule**: Tools with `--config` flags ‚Üí Build/. Tools with auto-discovery only ‚Üí Root.

## DDEV public/ Directory Exclusion

When using DDEV, a `public/` directory is created with TYPO3 entry points:

```
public/
‚îú‚îÄ‚îÄ index.php          # Frontend entry point
‚îî‚îÄ‚îÄ typo3/
    ‚îî‚îÄ‚îÄ index.php      # Backend entry point
```

**These are TYPO3 Core files, not extension code.** Exclude from linting:

```php
// Build/php-cs-fixer.php
$finder = PhpCsFixer\Finder::create()
    ->in(__DIR__ . '/..')
    ->exclude([
        '.Build',
        '.ddev',
        'Build',
        'public',  // ‚Üê TYPO3 entry points from DDEV
        'vendor',
    ]);
```

**Why exclude?**
- Files are TYPO3 Core, following TYPO3's conventions (not extension's)
- php-cs-fixer would want to add `declare(strict_types=1)` which breaks TYPO3 bootstrap
- Not part of extension distribution

## Configuration File Templates

### Build/phpstan.neon

```neon
includes:
    - vendor/phpstan/phpstan-strict-rules/rules.neon
    - vendor/saschaegerer/phpstan-typo3/extension.neon

parameters:
    level: max
    paths:
        - Classes
        - Tests
    tmpDir: .Build/phpstan
    reportUnmatchedIgnoredErrors: true
```

### Build/php-cs-fixer.php

```php
<?php

declare(strict_types=1);

$finder = (new PhpCsFixer\Finder())
    ->in(__DIR__ . '/../Classes')
    ->in(__DIR__ . '/../Tests');

return (new PhpCsFixer\Config())
    ->setRules([
        '@PSR12' => true,
        '@PhpCsFixer' => true,
        'declare_strict_types' => true,
    ])
    ->setCacheFile('.Build/.php-cs-fixer.cache')
    ->setRiskyAllowed(true)
    ->setFinder($finder);
```

### Build/rector/rector.php

```php
<?php

declare(strict_types=1);

use Rector\Config\RectorConfig;
use Rector\ValueObject\PhpVersion;
use Ssch\TYPO3Rector\Set\Typo3LevelSetList;

return RectorConfig::configure()
    ->withPaths([
        __DIR__ . '/../../Classes/',
        __DIR__ . '/../../Tests/',
    ])
    ->withPhpVersion(PhpVersion::PHP_82)
    ->withPhpSets(true)
    ->withSets([
        Typo3LevelSetList::UP_TO_TYPO3_13,
    ]);
```

## Resources

- **Tea Extension Structure:** https://github.com/TYPO3BestPractices/tea
- **Composer Documentation:** https://getcomposer.org/doc/06-config.md
- **TYPO3 Extension Structure:** https://docs.typo3.org/m/typo3/reference-coreapi/main/en-us/ExtensionArchitecture/FileStructure/
