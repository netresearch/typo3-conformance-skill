# TYPO3 Conformance Skill Enhancement Summary: v1.3.0 → v1.5.0

**Date:** 2025-01-17
**Versions:** v1.3.0 → v1.4.0 → v1.5.0
**Scope:** Complete TYPO3 v13 file structure validation and deprecation tracking

---

## Executive Summary

Enhanced the TYPO3 Conformance Checker skill with comprehensive validation capabilities for all TYPO3 extension files based on official TYPO3 v13.4 documentation. Added four new reference guides covering composer.json, ext_emconf.php, all ext_* files, and v13 deprecations with modern migration paths.

### Version Progression

**v1.3.0 → v1.4.0**: Added composer.json validation
**v1.4.0 → v1.5.0**: Added ext_emconf.php, all ext_* files, and v13 deprecation tracking

---

## Version 1.4.0: Composer.json Validation

### New Reference File
- **references/composer-validation.md** (456 lines)

### Capabilities Added

#### Mandatory Fields Validation
- Package name format: `<vendor>/<dashed-extension-key>`
- Package type enforcement: `typo3-cms-extension`
- Description presence and format validation
- License field validation (GPL-2.0-only, GPL-2.0-or-later)
- Autoload PSR-4 mapping verification
- **Critical**: `extra.typo3/cms.extension-key` requirement detection

#### Version Constraints Validation
- TYPO3 core dependency validation (`typo3/cms-core`)
- PHP version constraint validation
- Upper bound enforcement (detect missing `^` or upper limits)
- Multi-version compatibility patterns (`^12.4 || ^13.4`)

#### Deprecated Properties Detection
- Legacy `typo3-ter` vendor in replace property
- `self.version` in replace property
- Guidance on removing deprecated patterns

#### Synchronization Validation
- Mapping between composer.json and ext_emconf.php constraints
- Version constraint consistency checking
- Dependency alignment verification

### Validation Commands Provided
```bash
# Check extension-key presence
jq -r '.extra."typo3/cms"."extension-key"' composer.json

# Validate version constraints
jq -r '.require["typo3/cms-core"]' composer.json | grep -qE '(\^|[0-9]+\.[0-9]+\.[0-9]+-[0-9]+\.[0-9]+\.[0-9]+)'

# Detect deprecated replace
jq -r '.replace' composer.json | grep -q "typo3-ter\|self.version"
```

### Impact
- Catches TER publication blockers early
- Ensures Packagist compatibility
- Prevents dependency resolution issues
- Validates TYPO3 v12/v13 compatibility patterns

---

## Version 1.5.0: Complete File Structure and Deprecation Validation

### New Reference Files
1. **references/ext-emconf-validation.md** (456 lines)
2. **references/ext-files-validation.md** (414 lines)
3. **references/v13-deprecations.md** (409 lines)

---

## File 1: ext-emconf-validation.md

### Critical Restrictions Added

#### TER Upload Failure Prevention
**CRITICAL**: Detection of `declare(strict_types=1)` in ext_emconf.php
- Automated detection command
- Clear explanation of TER upload failure
- Correct/incorrect examples

#### Extension Key Validation
- Enforcement of `$_EXTKEY` variable usage
- Detection of hardcoded extension keys
- Validation commands for compliance

### Category and State Validation

#### Valid Categories
Complete enumeration with purposes:
- `be` — Backend-oriented functionality
- `module` — Backend modules
- `fe` — Frontend-oriented functionality
- `plugin` — Frontend plugins
- `misc` — Miscellaneous utilities
- `services` — TYPO3 services
- `templates` — Website templates
- `example` — Example/demonstration
- `doc` — Documentation
- `distribution` — Full site distributions

#### Valid States
Complete state machine with meanings:
- `alpha` — Initial development, unstable
- `beta` — Functional but incomplete
- `stable` — Production-ready
- `experimental` — Exploratory work
- `test` — Testing purposes only
- `obsolete` — Deprecated/unmaintained
- `excludeFromUpdates` — Prevent automatic updates

### Version Format Validation
- Semantic versioning enforcement (`[int].[int].[int]`)
- Detection of invalid formats (v-prefix, two-part versions)
- Validation regex patterns

### Constraints Structure
- Required `depends.typo3` and `depends.php` validation
- Version constraint format validation
- `conflicts` and `suggests` usage patterns
- Synchronization with composer.json requirements

### Complete Validation Script
Provided bash script with:
- Critical checks (strict_types, $_EXTKEY)
- Mandatory field validation
- Category/state validation
- Constraint validation
- Error counting and exit codes

### Common Violations Documented
Six common violation patterns with before/after examples:
1. Using declare(strict_types=1)
2. Hardcoded extension key
3. Invalid category
4. Invalid version format
5. Missing PHP/TYPO3 constraints
6. Mismatched composer.json constraints

---

## File 2: ext-files-validation.md

### ext_localconf.php Validation

#### Purpose and Structure
- Global configuration bootstrap documentation
- Required structure patterns (`declare(strict_types=1)`, `defined('TYPO3')`)
- What should/shouldn't be included lists

#### TYPO3 v13 Deprecations
- **CRITICAL**: `addUserTSConfig()` removal in v14.0
- Alternative: `Configuration/user.tsconfig` file
- Detection commands and migration patterns

### ext_tables.php Deprecation Status

#### Phasing Out Guidance
- TCA configurations → `Configuration/TCA/tablename.php`
- TCA overrides → `Configuration/TCA/Overrides/somefile.php`
- Backend modules → `Configuration/Backend/Modules.php` (v13.0)
- Static files → `Configuration/TCA/Overrides/sys_template.php`

#### Appropriate Remaining Uses
- Scheduler tasks with localization labels
- Custom page types registration
- Backend user settings extension

#### v13 Migration Examples
Complete before/after examples for backend module migration with file structure changes.

### ext_tables.sql Validation

#### SQL Syntax Requirements
- `mysqldump` utility output format
- Cross-DBMS compatibility (MySQL, MariaDB, PostgreSQL, SQLite)
- Partial definitions for extending existing tables

#### Table Naming Conventions
- Extension tables: `tx_<extensionkey>_domain_model_table`
- Core table extensions with prefixed fields

#### Auto-Generated Columns
- TCA-based automatic column generation
- `uid`, `pid`, and system fields handling

#### NEW in v13: Empty Table Definitions
Support for skeleton tables enriched entirely by TCA.

#### v13.4 CHAR/BINARY Handling
**WARNING**: Critical behavior change
- Fixed-length type proper flagging
- Extbase ORM incompatibility warning
- Best practice recommendations (VARCHAR over CHAR)

### ext_tables_static+adt.sql Validation

**NEW - COMPLETELY MISSING FROM PREVIOUS VERSIONS**

#### Critical Restrictions
- **ONLY INSERT statements allowed**
- No CREATE TABLE, ALTER TABLE, UPDATE, or DELETE
- Re-import behavior warning (data truncation)

#### When to Use
- Initial data during installation
- Lookup tables and predefined categories
- Default configuration data

#### Generation Command
Complete `mysqldump` command pattern for static data export.

### ext_conf_template.txt Validation

#### Comprehensive Syntax Format
```
# cat=Category; type=fieldtype; label=LLL:EXT:key/path.xlf:label
optionName = defaultValue
```

#### Complete Field Type Documentation
Full table of 10 field types:
- `boolean`, `string`, `int`, `int+`, `color`
- `options`, `user`, `small`, `wrap`, `offset`

#### Options and User Function Syntax
- Dropdown select patterns
- Custom function invocation patterns
- Nested structure examples

#### Localization Patterns
LLL: reference examples for multi-language support.

#### Accessing Configuration in Code
Complete PHP examples using `ExtensionConfiguration` dependency injection.

### Common Violations for All Files
Documented before/after examples for each file type:
1. addUserTSConfig in ext_localconf.php
2. Backend modules in ext_tables.php
3. CHAR usage in ext_tables.sql
4. CREATE statements in ext_tables_static+adt.sql

---

## File 3: v13-deprecations.md

### Deprecated Files (v13.1+)

#### ext_typoscript_constants.typoscript
**Status**: DEPRECATED since TYPO3 v13.1

**Migration Paths**:
1. **Preferred**: Site Settings Definitions (settings.definitions.yaml)
2. **Alternative**: Global constants via ext_localconf.php
3. Detection command
4. Impact warning for Site sets

#### ext_typoscript_setup.typoscript
**Status**: DEPRECATED since TYPO3 v13.1

**Migration Paths**:
1. **Preferred**: Site Sets (config.yaml + setup.typoscript)
2. **Alternative**: Global loading via ext_localconf.php
3. Detection command
4. Backward compatibility note

### Deprecated Methods (Removal in v14)

#### ExtensionManagementUtility::addUserTSConfig()
- Old approach example
- Modern approach: `Configuration/user.tsconfig`
- Detection command
- Complete migration pattern

### Modern Configuration Files (v12+)

#### Configuration/user.tsconfig
- Purpose and location
- User TSconfig examples
- Module hiding patterns
- Validation commands

#### Configuration/page.tsconfig
- Purpose and location
- Page configuration examples
- Backend layout definitions
- Complete backend layout syntax

### Modern Backend Configuration (v13)

#### Configuration/Backend/Modules.php
Complete documentation:
- Purpose and structure
- Modern registration array format
- All configuration options
- Controller action mapping

**Old vs New Comparison**:
- ext_tables.php `registerModule()` (deprecated)
- Configuration/Backend/Modules.php return array (modern)

### Site Sets (v13 Recommended Approach)

#### Configuration/Sets Structure
Complete directory tree:
```
Configuration/Sets/
└── MySet/
    ├── config.yaml (REQUIRED)
    ├── settings.definitions.yaml
    ├── setup.typoscript
    ├── constants.typoscript
    ├── page.tsconfig
    └── user.tsconfig
```

#### config.yaml Documentation
- Name and label requirements
- Dependencies with imports
- Settings with defaults

#### settings.definitions.yaml
Complete typed settings system:
- Type specifications (int, bool, string)
- Default values
- Labels and descriptions
- Enum patterns for select fields

#### Activation in Site Configuration
Site config.yaml integration with sets array.

### Migration Checklist

#### For v12 → v13 Migration
Five critical tasks:
1. Backend module migration
2. addUserTSConfig replacement
3. Page TSconfig modernization
4. ext_typoscript_constants deprecation
5. ext_typoscript_setup deprecation

#### For Modern v13 Extensions
Five recommended practices:
1. Configuration/Sets/ for TypoScript
2. settings.definitions.yaml for settings
3. Configuration/Backend/Modules.php for modules
4. Configuration/user.tsconfig for user TSconfig
5. Configuration/page.tsconfig for page TSconfig

### Complete Validation Script
Comprehensive bash script checking:
- Deprecated file presence
- Deprecated method usage
- Backend modules in wrong location
- Modern file presence verification

### Quick Reference Matrix
Complete mapping table:
| Old Approach | Modern Approach (v13) | Status |
|--------------|----------------------|--------|
| ext_typoscript_constants.typoscript | settings.definitions.yaml | Deprecated v13.1 |
| ext_typoscript_setup.typoscript | setup.typoscript | Deprecated v13.1 |
| addUserTSConfig() | Configuration/user.tsconfig | Removal in v14 |
| registerModule() | Configuration/Backend/Modules.php | Modern v13+ |

---

## Gap Analysis Results

### Major Gaps Identified and Addressed

#### Before v1.4.0 (v1.3.0 State)
1. ❌ composer.json: Missing extra.typo3/cms.extension-key requirement
2. ❌ composer.json: No version constraint validation
3. ❌ composer.json: No deprecated property detection

#### Before v1.5.0 (v1.4.0 State)
1. ❌ ext_emconf.php: Missing state values enumeration
2. ❌ ext_emconf.php: Missing category enumeration
3. ❌ ext_emconf.php: Missing critical TER restrictions
4. ❌ ext_localconf.php: Missing addUserTSConfig() deprecation
5. ❌ ext_tables.php: Missing v13 migration guidance
6. ❌ ext_tables.sql: Missing v13.4 CHAR/BINARY warnings
7. ❌ ext_conf_template.txt: Only mentioned as bonus, no validation
8. ❌ **ext_tables_static+adt.sql: COMPLETELY MISSING**
9. ❌ ext_typoscript_constants.typoscript: No v13.1 deprecation
10. ❌ ext_typoscript_setup.typoscript: No v13.1 deprecation
11. ❌ Configuration/Sets/: Not covered as modern standard

#### After v1.5.0
✅ All gaps addressed with comprehensive validation references

---

## SKILL.md Description Evolution

### v1.3.0 Description (Before)
```
Evaluates: extension architecture, dependency injection, services
configuration, testing coverage, Extbase patterns, best practices
alignment, and Crowdin integration.
```

### v1.4.0 Description (Intermediate)
```
Evaluates: extension architecture, composer.json validation (mandatory
fields, version constraints, deprecated properties), dependency injection,
services configuration, testing coverage, Extbase patterns, best practices
alignment, and Crowdin integration.
```

### v1.5.0 Description (Current)
```
Evaluates: extension architecture, composer.json validation (mandatory
fields, version constraints, deprecated properties), ext_emconf.php
validation (state values, categories, constraints, critical TER
restrictions), comprehensive ext_* files validation (ext_localconf.php,
ext_tables.php, ext_tables.sql, ext_tables_static+adt.sql,
ext_conf_template.txt), TYPO3 v13 deprecation detection (deprecated
TypoScript files, addUserTSConfig, backend module migration, Site sets
adoption), dependency injection, services configuration, testing coverage,
Extbase patterns, best practices alignment, and Crowdin integration.
```

---

## Files Created

### v1.4.0
- `references/composer-validation.md` (456 lines)
  - Commit: 5eebc73

### v1.5.0
- `references/ext-emconf-validation.md` (456 lines)
  - Commit: cac156f
- `references/ext-files-validation.md` (414 lines)
  - Commit: 70511bd
- `references/v13-deprecations.md` (409 lines)
  - Commit: 376570c

### Documentation
- `CHANGELOG.md` (118 lines)
  - Commit: 63bf03c

**Total New Content**: 1,853 lines of comprehensive validation documentation

---

## Validation Capabilities Enhancement

### Detection Commands Added
- 47 bash validation commands across all files
- 4 complete validation scripts (composer, ext_emconf, ext_files, v13-deprecations)
- Automated TER upload failure detection
- Deprecation detection for v13 → v14 migration

### Before/After Examples
- 15 complete violation/fix example pairs
- Clear visual distinction (❌ WRONG vs ✅ CORRECT)
- Real-world scenario coverage

### Migration Guidance
- 2 comprehensive migration checklists (v12→v13, modern v13)
- 6 complete migration path examples
- Modern alternative documentation for all deprecated approaches

---

## Impact Assessment

### Extension Developers
- **Reduced TER upload failures** via early validation
- **Clear migration paths** for v13 deprecations
- **Comprehensive file structure guidance** covering all ext_* files
- **Modern configuration patterns** with Site sets documentation

### Skill Quality
- **Complete v13 compliance** based on official TYPO3 v13.4 documentation
- **No missing files** - all extension files now covered
- **Actionable validation** with bash commands and scripts
- **Future-proof guidance** with v14 removal warnings

### Conformance Scoring
- **Enhanced accuracy** via comprehensive file validation
- **Deprecation detection** contributing to modernization scores
- **Critical restriction checking** preventing TER upload failures
- **Best practice enforcement** through modern alternative recommendations

---

## Technical Debt Resolution

### Addressed Issues
1. ✅ ext_tables_static+adt.sql completely missing → comprehensive documentation added
2. ✅ ext_conf_template.txt "bonus only" → full validation coverage
3. ✅ No v13 deprecation tracking → complete deprecation guide with migration paths
4. ✅ Missing critical TER restrictions → ext_emconf.php critical checks
5. ✅ No Site sets documentation → Configuration/Sets/ comprehensive guide

### Remaining Considerations
- Validation scripts could be packaged as standalone utilities
- Integration with typo3-tests skill for automated testing
- Potential for automated migration script generation

---

## Documentation Quality

### Reference File Structure
Each reference follows consistent pattern:
1. **Purpose Statement** - Clear scope definition
2. **Source Attribution** - TYPO3 Core API Reference v13.4
3. **Critical Sections First** - TER blockers and breaking changes
4. **Validation Commands** - Copy-paste ready bash scripts
5. **Before/After Examples** - Visual learning aids
6. **Complete Validation Scripts** - End-to-end checking

### Accessibility Features
- Table of contents (implicit through markdown headers)
- Consistent formatting and indentation
- Clear section separators (---)
- Emoji indicators (✅ ❌ ⚠️) for quick scanning
- Code blocks with language specifications

---

## Testing and Validation

### Source Verification
All content derived from official TYPO3 v13.4 documentation:
- ComposerJson.html
- ExtEmconf.html
- ExtLocalconf.html
- ExtTables.html
- ExtTablesSql.html
- ExtTablesStaticAdtSql.html
- ExtConfTemplate.txt
- ExtTyposcriptConstantsTyposcript.html
- ExtTyposcriptSetupTyposcript.html
- Directory structure documentation

### Validation Method
- Direct URL fetching via WebFetch MCP
- Line-by-line comparison with skill content
- Gap identification and prioritization
- Systematic documentation creation

---

## Future Enhancements

### Potential Additions
1. Automated conformance checking via standalone CLI tool
2. Integration with TYPO3 Extension Repository API for validation
3. Pre-commit hooks for local validation
4. CI/CD pipeline integration examples
5. Interactive migration assistant for v12→v13 upgrades

### Version Evolution Path
- v1.6.0: Automated validation tooling
- v1.7.0: CI/CD integration patterns
- v1.8.0: Migration assistant utilities
- v2.0.0: Full TYPO3 v14 preparation guide

---

## Conclusion

The v1.5.0 enhancement represents a complete overhaul of TYPO3 extension file structure validation, transforming the skill from basic conformance checking to comprehensive TYPO3 v13 compliance validation. All extension files are now covered with actionable validation commands, clear migration paths, and critical restriction detection.

**Key Achievement**: Complete alignment with official TYPO3 v13.4 standards with zero gaps in file coverage.

**Primary Beneficiaries**: Extension developers migrating to v13, teams maintaining TYPO3 extensions, and quality assurance processes requiring automated conformance validation.

**Next Steps**: Integration testing with real-world TYPO3 extensions and potential automation of validation scripts into standalone utilities.
